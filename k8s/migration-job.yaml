apiVersion: batch/v1
kind: Job
metadata:
  name: oc-client-backend-migration
spec:
  ttlSecondsAfterFinished: 300 # Clean up job after 5 minutes
  activeDeadlineSeconds: 600 # Job timeout after 10 minutes
  template:
    spec:
      imagePullSecrets:
        - name: ghcr-pull
      restartPolicy: Never
      containers:
        - name: migration
          image: IMAGE_PLACEHOLDER
          command: ['sh', '-c']
          args:
            - |
              set -e
              echo "Starting database migration..."
              echo "Environment: $NODE_ENV" 
              echo "Database URL configured: $([ ! -z "$DATABASE_URL" ] && echo "YES" || echo "NO")"

              echo "Generating Prisma client..."
              npm run db:generate

              echo "Running Prisma migration..."
              npm run db:migrate

              echo "Migration completed successfully"
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: database-url
            - name: NODE_ENV
              value: 'production'
          resources:
            requests:
              cpu: '100m'
              memory: '256Mi'
            limits:
              cpu: '500m'
              memory: '512Mi'
  backoffLimit: 3 # Retry up to 3 times on failure
